# ####

# .#.
# ###
# .#.

# ..#
# ..#
# ###

# #
# #
# #
# #

# ##
# ##

full_input = """>>>><<>>>><<><<<>>><<<>><<>>><<>>>><<<>>><<<>><<<<>>>><<<<>>>><<<>>>><<<<><><>>><<<<>><>>>><<<><<<>><<<<><>><<><<<<>>><>>>><>><>><<><<<><<<<>>><<<>><<<<><<<<>><<<<>><<>><<><>><>>>><><<<><>>><>>><<<><<<<>><<>>>><<<><<<>>><<<<>>><<<>><<>><<<>>><<<>><<<<>>><>><<<<>>>><<<<>>><>>>><>><>>>><<<<><>>><<<<>>><><<<<><<<><>>><<>>>><<<<>>>><<<>><<<<>>><><<>>><<><<><<>>><<<<>>><<<<>>><<<<><<<><<<><<>><<>><><<<><<>>>><<>><<>>>><<<<><<<<>><<<>>>><<>>>><<<<>>><<>><<><<<>>>><<><<>>><<<>><>>><>><<<<>>>><>><><<<<>>><>>><<>>>><<<><>>><>>><<<>><<>>>><<><<>>>><>><>>><<<>><<<>><<<>>><<<<><<<<>>><<>>><<>>>><>><>><<<>>>><<<<>>><<><<>><<>><<<<>>><<>>>><<>>><<<<>>>><>><<<>><>>><<>><<>>>><>><<>>><<<<><<<>>><<<<>>><>>>><<<><<<>>><<<>><<<>><<<<>>><>>><><>><>><>><<<><>>><<<>>><><<<<><<<>>>><><>>>><<>>>><<<>>><<<<>>><<>>>><<<><<>>>><>>><<<><>>>><<<<>><<<><<<>>><<<><<><<>>><<<>><<<><<<<>>><<>><<>>><>><><<<><<><>>><<<>><<>><<<><<<>><<<<><>><<<>>>><<<<>>>><>><<<<>>>><<<<>>><<<><<>><<>><<<><<<<><<<>>>><<><<<>>><<<<><<<><<<<>><<<<><>><<<<>>>><>><<<<><<<<>>><<<<>><<<<>>><<<<>><<>>>><<><<<><>>>><<<<><<<>>>><<>>>><<>>><<<<>><><<<>>>><<>>><>>><<<<>><<><<>>><>>>><>><<<>>>><<<<>>>><<<<>>>><<<>>><><<<><>><<<>>><<<><<<>>>><<<<><<<>>><<<<><<><>>><<<>><<<>>><<<<>>><<<<><<<>><>>>><<<>><>><<<<>><<>><>>>><>>>><<>><<>>>><<<<>>><<<>>><<><<<>>><<>><<<<>>>><<<>><<<<>><><>>><<<<>>><<<>>>><><>>>><<<<>>><<<<>><<<>>><>>><<<><><<>>><>>><<<<>><<<>>>><><<<<>><<>>><<<><<<<><<<><<<><>><<<>>><<<><<>><>><<<<>><<<<>>><<>><<<<>><<><<><<<<>>><<<>><<<>>>><>>><<>><<<<>><<<<>>><<<><>>>><<<>>><<<<><<<<>>>><<><<<<><<<>>>><<>>><>><<>><<<<>>>><><<<<>><<<>><<<><>>><<<<>>><<>>>><><<>>>><<<<>>><<<>>>><<<><<<<>>><<<<>>>><<<><<<>>>><><>><>><<>><<<>>><>>>><>><<>>><<>>>><<<>>>><<<>>>><<<>>>><<<<>>><>>>><<<><<<<>>>><>><<<><<<>>><<>>><<<<>><<<<>>>><>>>><<>>><<><>><>>><<<>>>><<<>>><<<>><<<>>>><<>><<<<>>><<<>>><<<<>><<<<>>><<>><<<>><<<>>><<>>>><>><<>><<<<>>>><<>>>><><<<>>><><><<>>>><<<>><><<><<<<>>>><<<<>><<<<>><><<<<>>>><><<><>>>><>><><>>>><<<<>>><<<<><<>><<<<><<><>>>><<>><>><>>><<><<><<>><<>>>><<<<>>>><>><<<<>>>><<<>><<<><<<>><<<<>><>><<>>><>><>>><<<>>><<<>><<<<>>><<>>><<<<>>><<><>>>><<<<><<<><><<>>><<<<>><<<<>>><<<<>>><<>>><<<<><>>><>>>><<<<>><<<>>>><><<<<><>>><<<<>>><<<>>>><<<>>><<<<>>>><<<<><>><>>><<>>><<<><<<><<<><<<><<>>><<>><<>><<>>>><><<<>>><<><<<<><<<<>><<<>>>><<>><<>>><<<<>><<<>><<<<>>>><<<<>>>><>><<><<<>><<<>>><<>><>>><<>>>><<<>>><><<>>>><<>>>><<<>>>><<<<>>><<>>><<<<><<<<><>>><><<<<>><<<<>>><<>>><>>><<>>>><<<<>><<<><<>><>>>><<<>>><<<<>><<<<><<<<>>>><<<><<<>><<>>>><<<>><>>>><<<>>>><<<<>>>><<<><<<><<<<>>><<>>><<<>>>><<>>>><<<>>><<><>>>><<<>><>>>><<<<><<<<>>><>>><>>>><><<<>>>><<>>><>>><<<<>><<>>><<<><<<<>><<<>>>><<<<><<<<>>>><<<<>><>>><<>>>><<<>>><>>>><>>><<<<>>><<<>>><<<><<>>><>>>><<>>><<>>><<>>><<<>>><<<<>>><>><<<>>><<<<>>><<<>><<<>><<><>><<>><<<<>>><<<>>>><<>>><<>>><<>>><<>><<<>>><<<<>>><<<<>>><<><<<>>><<>><>><<<<>>><>>><<<>>><<<><<<<>>><<<>>><>>>><<<>><<<<><>>><<<>>><<<<>><<<>>>><<>>>><><<<<>>>><<<<>>>><>>><<<>>><<<<><>><<>>>><><>><<<<>>><<<<>>><<>>>><<<<>>><<<>>>><>><<<<>>>><<><<><<<<>><<<<>><<<<>><<<<>>><<>><<<<><<><<>><<<>>>><<<>>>><>>><<>>><>>>><<<<><><<><>>>><<>>>><>>>><><<><<<>><<<><<>>><<><<><<<>>>><<>>>><<<<>>>><>>>><<>>>><<>>><<<><<<<>><<<<><>>><<<<><<>>>><<>>><<>>>><<<<>>><<<>>><<>>><<<>>><<<>>>><<<<><><>>><<<<>>>><<>><<<<>><>><<>>><<<<>>><>><<>>>><<<>>>><<<<><<<>>><<<<>>><>><<<<>>><<<<>>><<<>><<<<>>><<<>>><<>><<<>>>><<<>>><><<<><<<><<<<>><<><<<>>><<<<>>><<<<><<<<><<<<>><<<>>>><<><<>><<<><><<>>>><<<>>><<>>><<<<>>><<><>>><>>><<<><<<<>>><<<<><<>>><<<<>><<>>><<<<>>><><<<>>><<<><>><<<<>>>><<<<>><<<<>>>><<>>><<<<>>>><<<><<<<><<<>>>><<<<>>>><><<<>><<<>>>><<><<<<>><<<>>><><<>>>><<>>>><<<<><>><<<>>>><><<<>>>><><<<><<<>><>>>><<<>><>>>><><>>><<<><<>>>><<>>>><<><>><<>><<>>>><<<<>>>><<<>><<<>>><<<>>>><<>>><<<>>>><<<<>>><<<<>><<><>><<<>>>><<<<>>>><>>>><<<<><<>>>><<<<>>><>>><>>>><<<>>>><<<>>><<<>>>><<<>>><<<<><><<<>>>><>><<<><>>>><<<><<<<><<<>>><><<>>><<<<>><<<>>><<<><<<>>>><<<<><<<<><<<><<<>><<<<>>>><<>><><<<>>><<<<>>>><<<>>><<>><<<>><<<>>><<<><<<<><<<<>>><<>>><><>>>><<<>>>><<>>>><<<<><>>><>>>><<<>>>><<<<>><>>>><<>><<>>>><<<<>>>><>>><<><<<<>>><<<><>><>><<<><<<<>><<<>><><<<<>><>>>><<>><<<>>><>>><<>><<>>><><<<<><<<<>><<<<>>>><<>>><<>><><<<<>>>><<><<<>>>><<<<><<<<>><<>><<<>><>><>><<<>><<<<><>><<<<><<>>>><<<<><>><>><>>>><>><<<<><>><>>>><<<>>>><<<<>><<<<><<<<>>>><>>><<<><>><<>>>><<>>>><<<>><<>><<<<>>><><<<><<<<><<<<>>><<>>>><>>><>>>><<>>>><<<><<<<>><<>>>><<>>>><<<>>><<><<><<>>>><<>>><<<><<<>>>><<<><>>><<>><><<>><<<>>>><<><<<<>><<><<<>><>>><<<>>>><<<<>>>><<<>>>><<<>><<>>>><<><>>>><<<><<>>><<<<>><<<><<<>>><<>>><>>><<>>>><<>><<><>><<<<>>><><><<<<>>>><<>><<<>>>><>>><<<>>><<<<><<>>><>><<<<>>>><>>><<<<>>>><<<<>>>><<<<>>>><<<>><>><<<>>>><<<><<<<>>>><<><<>><<<<>>><<>>>><<<<><<<<>>>><<<<><<<>>><<<>>>><<<<>>>><>>>><>>>><<<>>><<<>>><<<<>>><<<>><<<>>>><<>><<>>>><>>>><>>>><<<>>><>>>><>>><<<<>>><<<<>>>><>>><>>><>><>>><<<>>><<<<>>><<<<><>><<<><>>><<>><<<>>>><<<>><><<<>>><<<><<>><>>>><<<>>><><<><>>><<<<>><<<<><<<>>>><<<>>><><<<<>>><<<><<><<<>>><<><<>>>><<<>>>><<><<<>>>><>>><<>><<<><<<>>>><<<<>><>>>><<>>><<<<>>><<><>>>><<<<>>><<<>>><<><<<<>>><<<<>>><<<<>>>><<<>>>><>>><<<>>><<>><<<>>>><<<><><<<<><<<<>>>><<>>><>>><<<<><<<>><<>>>><><<<><<>>><<<<>>><<>>><<<<><<<>>><<<>>>><>>><>>><<><><<>><<>>><<<<>>><<>><<<>>>><>>>><>><<><<<>>><<><<<<>>>><<>>>><<<<>><<>>><<<<><<<<>>><<>>><<<<><><>>>><<<>>><<<<>>><>>>><<<>><<<>>>><<<<><<<>>>><<><<>>>><<>><<<<>><<<>>><<<>>>><<<<><<>><>>><<<>><<<>>>><<<<>>><<>><<<<>><>>><<>>><<<>>><>><<<>>>><<>>>><<<<>>><<>>><>>><>><>>>><>>>><<>>>><>>><<<><>>>><<<<>>><<<<>>><<<<>>><<<>>>><<>>>><>>><<<>>><<<<>><<<<>><<>>>><<<<><<>>><<<<><<<><<<><<>>>><<<>><<><<>>><<<>>><<>>><<>>>><>>>><><<<<><>>><<>>><<><<<><<<>>><<<>>>><<<>>><>><>>>><<<>>>><<<>>>><>><>>>><<<<>>><<<>>><<<<>><<>><<>>><<<<>>>><<<>>><<><<<<>><>>>><>><<>>>><>>><>>><><<<<>>><<<<>>><<<<><<<<>>>><<<<><<>>>><<<<>>>><<<<>>><<<>>><<>><<>><<<>>><>>>><>>>><<<<>>>><<<>>>><<<<>>>><<<>><<<>>><<<>><<<<>><<>>><<>>><<<<>><<<<><<<<>>>><<<<>>>><<>><<<>>>><><>>><<><<>><<<>>><>>><<>>>><<><>>><<><<>>><<>>>><><>>>><<<<>>>><<<><<>><<>>><<<<>>>><<<<>><<<<>><<>><<><<>><<<>>>><<<<><><<<<>>>><><<>>>><>>><>><<<<>><<<><<<>><<>>>><><>>>><<>><<>>><<<<><<<>><<<<>>><<<<>><<<<>><<<>><<<<><<<>>><<>>><<<<>>>><>>>><<>><<>>>><<>>>><<>>><>>><<<><><<<><<<>><><>>>><<<<>>><<<><<<>><<><<<<><<<<><<><<<<>>>><>><<<<><<>>>><>>>><<<>>><>>><><<<<>><<<>><<>>>><<<<><>>>><<<>>>><<<>><>>>><<>>>><<<>>><<>>><<<>><<<><<<<>>><><<>>>><<<>>><<>>>><>>>><>>><<<>>>><<<>><>><<<<>>><<<>>><><<<><<>><<<>>><<<<><><<<<>>>><<>>>><<<>><<<>><<>>><>><<<>><<<>>><<<><<<>><<>><<>>><<<<>>><<><<<><<>><<<>>><>>><<>><<>><<<<>>>><<><<<<>>><<>>><>>><<><>>>><<<<>><<>>>><>><<<<>>><<><<<>>>><<<><>>>><<<>>><<<><<<>><<<>><<<<>><><<<<>>><>>><<>>>><<<>>><<<>>>><<<<>>><<<<>>>><<<>>>><>>><<<<>>>><>>><<<<><<>>><<>><<<<>><><<>><<<<>><<<>><<><<>>>><><<<<>>><<><<><<<>>>><<<>>>><<><<<>>>><<<><>>>><>><<><<<<>>><>><<<><>><<<>>>><<<><<><<<>>>><<>>><<<<><<><<<>><<<><<<<>>>><<<>>><<<<><<<>><<<>>>><>>>><<<<>>>><<<>>><<<<>>>><<<>><<>><<>><>>>><<<<>><<<><>><<<<><<<<><<>><<<>>><<>>>><<><>>>><<<<>><<><<<>>><<<><<<<>>>><<<>>>><<<>>><<<>>><<<<>>><<<>>><<>><<<>>><><><<<>><>>>><<<<>><<>>><<><<>>><<<<>><<>><><<<<>>><<>>>><<><>><<>>><<><<<>>><<>>>><><>><<><<>><<><<<<>>>><<>>>><>>>><<<<>>>><>><>><<<>>>><<>>>><<><>>>><<<<>>>><<<<>>><<<<><<<<>><<>>>><<<><<<>><<<<><<<<>><<<><<>>>><>><<>>>><<<>>>><<>>><<<<>><<<<><<>>>><>>>><>><><<>><<><<<><<>><<<>>><<<>>>><<<<>>><<<<>>>><<<><>>><<>><<<><<<<><<>>><<<<><<<><<<>><<>>>><><<><<<<>><>><<<>><<<<>>><<<<>>><>>><<<><<<>><<>>><<<>>><<<>><<<<>>>><<<>><<<>><<<<>>><>>>><>><<>><<>><<<>><<>>>><<<<><>><<<>>>><<<<>><<<<><<<<>>><<<<>>><<<<>>><<>><<<><<<>>><<<>><<>>><<>>><<>>>><<>>><<>><><><<<>><<<>>><<<><<>>><>><<><<<<>>>><<<>><>>><<>><>>><<<>>><<<>>><<<>>><>><<>><<>>><><<<>><<>><<>>>><<<<><>>>><>>>><<<<>>><<>>><<<>>><><>><<<<><>><<<>>>><<<>>>><<<<><<<>>><>><<>>>><<<><>>>><<<>><<<>>><<<<><<><<<>>><<><>>>><<<>><<<<>>>><<<<><<<<>>>><<><<<>><<<>>>><>>><<><<>><<>>><>>><<<><<<<>>>><<<<><<<<>><>><>>>><<<>>>><<<><<>>>><><<<<>><<<>><<><<<><<<>>><<<>><<<>>>><<>>><<<<>><<>>><>><<<<>>>><<<<>><>><<>>>><<>>>><<<>>><>>>><<<><<<<>>>><<><<>>><<<<>><<<>>><<<>><>><<<>>><<>>><<><>>>><>>><><>>><<>><>>><<>><<<<>><>><<>><><<<>>>><<>>><<>>>><<<>><<>><<<<>><<<><<<<>><<<<>><>>><<>>>><<<<><<>>><<<><>><<<><<<>>>><<<<>>><>><<<<>>>><<<<>>><<<<>>><>>>><<>>>><<<<>>><<><<><>><><>>>><<<<>><<>>><<><<<>><>>><>>><<<<>>>><<>>><<<><<>>><<<>><<<<><><><<><<<><>>><>>>><>>><>>><<>>>><<>>><<<<>>>><<><>><<>>>><<<><<<>>>><<<>>>><<<<>>>><<<<><<<>>><<<<>>><<<>>><>><<<>>><<>>><<<>>>><>>>><<>><<>>><>><<<<>>>><<<<>><>>>><><<<>>>><>>><<>>>><<<>><<<<><>>>><<<<>><<>><>>><><<<<>>>><<<<>><<<>><>>>><<<<>>>><<<><<<><<<<>>><>><><<<>>>><<>>><<<>><<>>><<>><<>><<<<><<<><><>><>>><<<<>>>><<>>>><<<>><>>>><<<<><>><<>>><<>>>><<>>>><<<<>>><<<><<>><<><>>><>><<>><<<<>>>><<<>>>><<<>>><<>>>><<<<><><<>>>><<<><<>>>><<<><<<<>><<<<>>><<>>><>><<<<><<<>><<<>>>><<<<>>><<<<>><<<>>>><<<<>>>><<<>><>>><>><<>>><<>>>><<<<>><<><<><<>>><>>><<<>>>><<<><<<>><<<>><<<>><<>><<<>>>><<<>>>><>>>><>><<<<>>>><<><<<<>>><>>>><<>>><<<>>>><<<>>><<<<>>>><>>><><<<<>>><<<<>>>><><<<>><><>><<<><<<>>>><<>>>><<<<>>>><>>>><<>>><<<<>><<<><<>>><<<<>><<<<>><>><<<<>>>><<<>>><<<<>>>><<<>>><<>><<<>><<>>><<>>>><<<>>><>>>><<<<>><<<<>>>><>><<<>><<<<>><<>><<<>>>><<<>>><<<>>>><<<<>><<<><><>>><<<<><<<>>>><<<>>><<<<>>>><<<>>>><<>><<><<<>>><<>><><<<>>>><<>><<<>>>><<<>>><<<<><<>>>><<<<><><<<><><<<<>><<><<<><<<>><<>><<>><<>><>>><>>>><><><<<>><<>><<<>><<<<>>><<>>>><<<<>>><<<>><>>><<<>><>>>><<<>>><<<>><<<<>>><<>>>><>>>><<>>><<<><<<>>><<<<>>>><<<<><<<>>>><<>><<<><<><><>>>><<<<>>><>>><<<<>><<<>><<<>>>><<<<>>>><<<>><<<<>>>><<<>>><>>><<<><<<<>>><<<<>><<<>>><<<>><<<<>>>><<<>>><<>>><>>>><<<<>><<>>>><<<<>>>><<>><<>><<<<>>>><<<>>><<<><<<>>>><<<<>>>><<<>>>><<>>>><<<<>>><<>>><<<><<<<>>>><>>>><<>>><<>>><<<<>><<<>><><<>>><>>>><<>>><<<<>>><>>><<<<>>><<>>><<<<>><<>>>><<<>>>><>><<<>><<<<>>>><><<<<>>>><<<>>><>>>><<>><<<>>><<><<<<>><<>>>><>>>><<>>><<>>>><<<>>><>>>><>>>><>>>><<<<>><<<>><<<<>><<<>>>><>>><<<<>><><<<<>>>><<>>>><<>><>><<>>><<>><>>>"""

test_input = """>>><<><>><<<>><>>><<<>>><<<><<<>><>><<>>"""

class Rocktris:
    DEFAULT_SHAPES = [
        [[True, True, True, True]],
        
        [[False, True, False],
         [True, True, True],
         [False, True, False]],
         
        [[False, False, True],
         [False, False, True],
         [True, True, True]],
          
        [[True],
         [True],
         [True],
         [True]],
         
        [[True, True],
         [True, True]]
        ]
    
    STARTING_HEIGHT=1000
    
    ROCK = '#'
    EMPTY = '.'
    
    def __init__(self, jets, width=7, num_drops=2023, shapes=None):
        self.jets = jets
        self.jet_index = 0
        self.width = width
        self.num_drops = num_drops
        if shapes is None:
            self.shapes = self.DEFAULT_SHAPES
        self._initialize_grid()
        self.top = 0
        self.current_shape = None
        self.bottom_left = None
        
    def __str__(self):
        result = ''
        for i in range(self.top + 7):
            line = self.grid[i]
            line_str = ''
            for space in line:
                line_str += self.ROCK if space else self.EMPTY
                line_str += ' '
            result = line_str + '\n' + result
        return result
        
    def _initialize_grid(self):
        self.grid = [[False for _ in range(self.width)] for _ in range(self.STARTING_HEIGHT)]
    
    # These three functions have very similar structures. Could/should that structures
    # be abstracted out into its own function?
    def remove_shape(self):
        x,y = self.bottom_left
        for dy, row in enumerate(reversed(self.current_shape)):
            for dx, space in enumerate(row):
                if space:
                    self.grid[y+dy][x+dx] = False
                    
    def try_shape(self, sx, sy):
        if (sx < 0 or
            sx + len(self.current_shape[0]) > self.width or
            sy < 0 or
            sy + len(self.current_shape) > len(self.grid)):
                return False
        for dy, row in enumerate(reversed(self.current_shape)):
            for dx, space in enumerate(row):
                if space and self.grid[sy+dy][sx+dx]:
                    return False
        return True
                    
    def place_shape(self, sx, sy):
        self.bottom_left = (sx, sy)
        for dy, row in enumerate(reversed(self.current_shape)):
            for dx, space in enumerate(row):
                if space:
                    self.grid[sy+dy][sx+dx] = True
        
    def move_shape(self, dx, dy):
        x, y = self.bottom_left
        # First check to make sure the coordinates are valid
        newx = x + dx
        newy = y + dy
        self.remove_shape()
        if self.try_shape(newx, newy):
            self.place_shape(newx, newy)
            return True
        else:
            self.place_shape(x, y)
            return False
        
    def spawn_shape(self, shape):
        self.current_shape = shape
        self.bottom_left = (2, self.top+3)
        # Check if we need to extend the grid
        if self.top + 3 + len(shape) >= len(self.grid):
            for _ in range(self.STARTING_HEIGHT):
                self.grid.append([False for _ in range(self.width)])
        self.place_shape(*self.bottom_left)
            
    def drop_shapes(self, num_drops=None):
        if num_drops is None:
            num_drops = self.num_drops
        for i in range(num_drops):
            self.spawn_shape(self.shapes[i % len(self.shapes)])
            # print(self)
            falling = True
            j = 0
            while falling:
                # print(self)
                # input()
                direction = self.jets[self.jet_index]
                self.jet_index = (self.jet_index + 1) % len(self.jets)
                if direction == '<':
                    self.move_shape(-1,0)
                elif direction == '>':
                    self.move_shape(1, 0)
                # print(self)
                # input()
                falling = self.move_shape(0, -1)
            shape_top = self.bottom_left[1] + len(self.current_shape)
            self.top = max(self.top, shape_top)
        return self.top
        
test_rocktris = Rocktris(test_input)
print(test_rocktris.drop_shapes(2022))

full_rocktris = Rocktris(full_input)
print(full_rocktris.drop_shapes(2022))
